
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>veroku.cluster_graph &#8212; veroku 0.0.14 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for veroku.cluster_graph</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Graph</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Source</span>

<span class="kn">from</span> <span class="nn">veroku._cg_helpers._cluster</span> <span class="kn">import</span> <span class="n">Cluster</span>
<span class="kn">import</span> <span class="nn">veroku._cg_helpers._animation</span> <span class="k">as</span> <span class="nn">cg_animation</span>
<span class="kn">from</span> <span class="nn">veroku.factors._factor_utils</span> <span class="kn">import</span> <span class="n">get_subset_evidence</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">veroku.factors.gaussian</span> <span class="kn">import</span> <span class="n">Gaussian</span>


<span class="c1"># TODO: optimise pass_message</span>
<span class="c1"># TODO: improve sepsets selection for less loopiness</span>
<span class="c1"># TODO: Optimisation: messages from clusters that did not receive any new messages in the previous round, do not need</span>
<span class="c1">#  new messages calculated.</span>


<div class="viewcode-block" id="evidence_reduce_factors"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.evidence_reduce_factors">[docs]</a><span class="k">def</span> <span class="nf">evidence_reduce_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">evidence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Observe relevant evidence for each factor.</span>
<span class="sd">    :param factors:</span>
<span class="sd">    :param evidence:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reduced_factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">evidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vrs</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">get_subset_evidence</span><span class="p">(</span><span class="n">all_evidence_dict</span><span class="o">=</span><span class="n">evidence</span><span class="p">,</span>
                                              <span class="n">subset_vars</span><span class="o">=</span><span class="n">factor</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vrs</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">reduced_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">reduced_factors</span></div>


<div class="viewcode-block" id="make_factor_name"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.make_factor_name">[docs]</a><span class="k">def</span> <span class="nf">make_factor_name</span><span class="p">(</span><span class="n">factor</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">factor</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="absorb_subset_factors"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.absorb_subset_factors">[docs]</a><span class="k">def</span> <span class="nf">absorb_subset_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Absorb any factors that has a scope that is a subset of another factor into such a factor.</span>
<span class="sd">    :param factors:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factors_absorbtion_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">))}</span>
    <span class="n">final_graph_cluster_factors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># factors: possibly smaller list of factors after factors which have a scope</span>
    <span class="c1"># that is a subset of another factor have been absorbed by the larger one.</span>
    <span class="c1"># print(f&quot;Info: Absorbing subset factors. (initial number of factors: {len(factors)})&quot;)</span>
    <span class="n">factor_processed_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">factor_product</span> <span class="o">=</span> <span class="n">factor_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">factor_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">factor_j</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">factor_product</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
                            <span class="c1"># print(f&#39;Absorbing {factor_j.var_names} into{factor_product.var_names}&#39;)</span>
                            <span class="c1"># factors_absorbtion_dict[make_factor_name(factors[i])].append(make_factor_name(factors[j]))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">factor_product</span> <span class="o">=</span> <span class="n">factor_product</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">factor_j</span><span class="p">)</span>
                                <span class="n">factors_absorbtion_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: could not multiply </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">factor_product</span><span class="p">)</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">factor_j</span><span class="p">)</span><span class="si">}</span><span class="s1"> (Not Implemented)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">final_graph_cluster_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_product</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>  <span class="c1"># add remaining factors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">factor_processed_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">final_graph_cluster_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factor_i</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">factor_processed_mask</span><span class="p">),</span> <span class="s1">&#39;Error: Some factors where not included during variable subset processing.&#39;</span>
    <span class="k">return</span> <span class="n">final_graph_cluster_factors</span><span class="p">,</span> <span class="n">make_subset_factor_df</span><span class="p">(</span><span class="n">factors_absorbtion_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_subset_factor_df"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.make_subset_factor_df">[docs]</a><span class="k">def</span> <span class="nf">make_subset_factor_df</span><span class="p">(</span><span class="n">subset_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a ...</span>
<span class="sd">    :param subset_dict: (dict) A dictionary mapping factors to factors that have subset scopes</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subset_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subset_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="c1"># TODO: This raises different list lengths warning. Investigate this.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;factor_index&#39;</span><span class="p">,</span> <span class="s1">&#39;subfactor_indices&#39;</span><span class="p">],</span>
                      <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;num_subfactors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;subfactor_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;num_subfactors&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="ClusterGraph"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph">[docs]</a><span class="k">class</span> <span class="nc">ClusterGraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">evidence</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">special_evidence</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">make_animation_gif</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">disable_tqdm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a Cluster graph from a list of factors</span>
<span class="sd">        :param factors: (list of factors) The factors to construct the graph from</span>
<span class="sd">        :param evidence: (dict) evidence dictionary (mapping variable names to values) that should be used to reduce</span>
<span class="sd">            factors before building the cluster graph.</span>
<span class="sd">        :param special_evidence: (dict) evidence dictionary (mapping variable names to values) that should be used in</span>
<span class="sd">            the calculation of messages, and not to reduce factors. This allows factor approximations - such as the</span>
<span class="sd">            non-linear Gaussian to be iteratively refined.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_mp_iters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_passed_message_factors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_animation_gif</span> <span class="o">=</span> <span class="n">make_animation_gif</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span> <span class="o">=</span> <span class="n">special_evidence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span> <span class="o">=</span> <span class="n">disable_tqdm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_index_strings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_passed_message_factors_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="c1"># new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_sent_message_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {(rec_cluster_id1, rec_cluster_id1): msg1, ...}</span>

        <span class="n">all_evidence_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">evidence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evidence_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">evidence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">all_evidence_vars</span> <span class="o">=</span> <span class="n">all_evidence_vars</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">evidence_vars</span><span class="p">)</span>

        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">all_factors_copy</span> <span class="o">=</span> <span class="n">evidence_reduce_factors</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">evidence</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: Copy factors and reduce evidence time duration: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">final_graph_cluster_factors</span><span class="p">,</span> <span class="n">absorbtion_df</span> <span class="o">=</span> <span class="n">absorb_subset_factors</span><span class="p">(</span><span class="n">all_factors_copy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: Absorbing subset factors time duration: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Info: Factor subset factors. (reduced number of factors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_graph_cluster_factors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">Cluster</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">cluster_name_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">#&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor</span> <span class="ow">in</span>
                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_graph_cluster_factors</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_non_rip_sepsets</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="s1">&#39;Info: Calculating sepsets&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>
            <span class="n">vars_i</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)):</span>
                <span class="n">vars_j</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span>
                <span class="n">sepset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vars_j</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vars_i</span><span class="p">))</span> <span class="o">-</span> <span class="n">all_evidence_vars</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_non_rip_sepsets</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sepset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_non_rip_sepsets</span><span class="p">[(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sepset</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sepset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_neighbour</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span> <span class="o">=</span> <span class="n">clusters</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: Calculating sepsets time duration: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: number of clusters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)</span><span class="si">}</span><span class="s1"> (should be </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_graph_cluster_factors</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">prev_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: building graph&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: build graph time duration: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">prev_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_animation_frames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rip_sepsets_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the cluster sepsets, graphviz graph and animation graph (for message_passing visualisation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for non-unique cluster_ids (This should never be the case)</span>
        <span class="n">cluster_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cluster_ids</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Non-unique cluster ids: </span><span class="si">{</span><span class="n">cluster_ids</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># self.graph_animation = Animation()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="s1">&#39;Info: Building graph.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rip_sepsets_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rip_sepsets_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_intersection_sepsets</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Debug: number of clusters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>
            <span class="c1"># TODO: add cleaner solution?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">remove_all_neighbours</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>

            <span class="n">node_i_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_cluster_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">node_i_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">node_i_name</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)):</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rip_sepsets_dict</span><span class="p">:</span>
                    <span class="n">sepset</span> <span class="o">=</span> <span class="n">rip_sepsets_dict</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sepset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Error: empty sepset&#39;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_neighbour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sepset</span><span class="o">=</span><span class="n">sepset</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add_neighbour</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sepset</span><span class="o">=</span><span class="n">sepset</span><span class="p">)</span>
                    <span class="n">node_j_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">_cluster_id</span>
                    <span class="n">sepset_node_label</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sepset</span><span class="p">)</span>
                    <span class="n">sepset_node_name</span> <span class="o">=</span> <span class="n">cg_animation</span><span class="o">.</span><span class="n">make_sepset_node_name</span><span class="p">(</span><span class="n">node_i_name</span><span class="p">,</span> <span class="n">node_j_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">sepset_node_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">sepset_node_label</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;rectangle&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">node_i_name</span><span class="p">,</span> <span class="n">sepset_node_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">penwidth</span><span class="o">=</span><span class="s1">&#39;2.0&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">sepset_node_name</span><span class="p">,</span> <span class="n">node_j_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">penwidth</span><span class="o">=</span><span class="s1">&#39;2.0&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterGraph.conditional_print"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.conditional_print">[docs]</a>    <span class="k">def</span> <span class="nf">conditional_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.get_cluster_ids"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_cluster_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_cluster_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all the ids for all the clusters.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">]</span></div>

<div class="viewcode-block" id="ClusterGraph.show_cluster_ids"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.show_cluster_ids">[docs]</a>    <span class="k">def</span> <span class="nf">show_cluster_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: delete this</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> id: &#39;</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">,</span> <span class="s1">&#39;   var_names: &#39;</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.plot_message_convergence"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.plot_message_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">plot_message_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the message passing convergence over the consecutive iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: combine with one below - this one gets messed up by inf values</span>
        <span class="n">message_kld_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span>
        <span class="n">columns_mask</span> <span class="o">=</span> <span class="n">message_kld_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;distance_from_previous&#39;</span><span class="p">)</span>
        <span class="n">message_kld_distances_only_df</span> <span class="o">=</span> <span class="n">message_kld_df</span><span class="p">[</span><span class="n">message_kld_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">columns_mask</span><span class="p">]]</span>
        <span class="n">message_kld_distances_only_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">message_kld_distances_only_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;KL Divegences between Messages and Previous Iteration Messages&#39;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">message_kld_distances_only_df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;KLD&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;message passing iteration&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.plot_message_convergence_new"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.plot_message_convergence_new">[docs]</a>    <span class="k">def</span> <span class="nf">plot_message_convergence_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">]):</span>
        <span class="c1"># TODO: improve this (inf value workaround is a bit hacky)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span>
        <span class="n">kl_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;distance&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">kl_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">kl_cols</span><span class="p">]</span>

        <span class="n">no_inf_df</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">max_no_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">no_inf_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">no_inf_df</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">min_no_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">no_inf_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">inf_to_max_df</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">max_no_inf</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">inf_to_max_min_df</span> <span class="o">=</span> <span class="n">inf_to_max_df</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">min_no_inf</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">inf_to_max_min_df</span><span class="o">.</span><span class="n">values</span>
        <span class="n">max_kl_div_per_iteration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">max_kl_div_per_iteration</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Message Passing Convergence&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;log max message kld&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;message passing iteration&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_unique_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">:</span>
            <span class="n">all_vars</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
        <span class="n">unique_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_vars</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">unique_vars</span>

    <span class="k">def</span> <span class="nf">_get_vars_min_spanning_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_unique_vars</span><span class="p">()</span>
        <span class="n">var_graphs</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="p">}</span>
        <span class="n">num_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_clusters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">):</span>
                <span class="n">sepset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_non_rip_sepsets</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sepset</span><span class="p">:</span>
                    <span class="n">var_graphs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">var_spanning_trees</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="p">:</span>
            <span class="n">var_spanning_trees</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">minimum_spanning_tree</span><span class="p">(</span><span class="n">var_graphs</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">var_spanning_trees</span>

<div class="viewcode-block" id="ClusterGraph.get_running_intersection_sepsets"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_running_intersection_sepsets">[docs]</a>    <span class="k">def</span> <span class="nf">get_running_intersection_sepsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">edge_sepset_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">unique_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_unique_vars</span><span class="p">()</span>
        <span class="n">min_span_trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vars_min_spanning_trees</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="s2">&quot;Info: Getting unique variable spanning trees.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_vars</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">unique_vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">min_span_tree</span> <span class="o">=</span> <span class="n">min_span_trees</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">min_span_tree</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edge_sepset_dict</span><span class="p">:</span>
                    <span class="n">edge_sepset_dict</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_sepset_dict</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">edge_sepset_dict</span></div>

<div class="viewcode-block" id="ClusterGraph.show"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;/tmp/test.gv&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="s1">&#39;/tmp/test.gv.png&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.save_graph_image"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.save_graph_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_graph_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save image of the graph.</span>
<span class="sd">        :param filename: The filename of the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Source(self._graph, filename=&quot;/tmp/test.gv&quot;, format=&quot;png&quot;)</span>
        <span class="n">Source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.get_factors"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_factors">[docs]</a>    <span class="k">def</span> <span class="nf">get_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the cluster factor for each cluster in the graph</span>
<span class="sd">        :return: A list of cluster factors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cluster</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">]</span></div>

<div class="viewcode-block" id="ClusterGraph.get_marginal"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_marginal">[docs]</a>    <span class="k">def</span> <span class="nf">get_marginal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search the graph for a specific variable and get that variables marginal (posterior marginal if process_graph</span>
<span class="sd">        has been run previously).</span>
<span class="sd">        :return: The marginal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">vrs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">var_names</span><span class="p">):</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">evidence_vrs</span><span class="p">,</span> <span class="n">evidence_values</span> <span class="o">=</span> <span class="n">get_subset_evidence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="p">,</span> <span class="n">factor</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evidence_vrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">evidence_vrs</span><span class="p">,</span> <span class="n">evidence_values</span><span class="p">)</span>
                <span class="n">marginal</span> <span class="o">=</span> <span class="n">factor</span><span class="o">.</span><span class="n">marginalize</span><span class="p">(</span><span class="n">vrs</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">marginal</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No cluster with variables containing </span><span class="si">{</span><span class="n">vrs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.get_posterior_joint"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_posterior_joint">[docs]</a>    <span class="k">def</span> <span class="nf">get_posterior_joint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: add functionality for efficiently getting a posterior marginal over any subset of variables and replace</span>
        <span class="c1"># the get_marginal function above.</span>
        <span class="n">cluster_product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">joint_distribution</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">cluster_product</span> <span class="o">=</span> <span class="n">cluster_product</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">joint_distribution</span><span class="p">)</span>
        <span class="n">last_passed_message_factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_passed_message_factors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_passed_message_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">cluster_product</span>
        <span class="n">message_product</span> <span class="o">=</span> <span class="n">last_passed_message_factors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">message_factor</span> <span class="ow">in</span> <span class="n">last_passed_message_factors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">message_product</span> <span class="o">=</span> <span class="n">message_product</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">message_factor</span><span class="p">)</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">cluster_product</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">message_product</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">joint</span></div>

<div class="viewcode-block" id="ClusterGraph.get_factor"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_factor">[docs]</a>    <span class="k">def</span> <span class="nf">get_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the factor associated with a specific cluster.</span>
<span class="sd">        :param cluster_id: The id of the cluster of which the factor will be returned.</span>
<span class="sd">        :return: The factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of clusters = &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cluster.cluster_id  </span><span class="si">{</span><span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span> <span class="o">==</span> <span class="n">cluster_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cluster</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find cluster with id </span><span class="si">{</span><span class="n">cluster_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.make_all_messages"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.make_all_messages">[docs]</a>    <span class="k">def</span> <span class="nf">make_all_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate through all clusters and make messages to all the neighbours of a cluster for each of</span>
<span class="sd">        the clusters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_mp_iters</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">message_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">neighbour_id</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">neighbour_ids</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">make_message</span><span class="p">(</span><span class="n">neighbour_id</span><span class="p">,</span> <span class="n">evidence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="n">message_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">messages</span></div>

<div class="viewcode-block" id="ClusterGraph.get_ranked_message_df"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_ranked_message_df">[docs]</a>    <span class="k">def</span> <span class="nf">get_ranked_message_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_message_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dataframe containing message objects, their sender and receiver cluster ids, and the distance from their</span>
<span class="sd">        previous iterations.</span>
<span class="sd">        :param previous_message_df: The message dataframe to use to compute the distances</span>
<span class="sd">            (distance from vacuous will be used if this is None)</span>
<span class="sd">        :return: The ranked message dataframe sorted by the distance_from_previous column (from high to low)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_all_messages</span><span class="p">()</span>
        <span class="n">factors_are_vacuous</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">is_vacuous</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">factors_are_vacuous</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: All messages are vacuous&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no messages to send.&#39;</span><span class="p">)</span>
        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;message_object&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;message_scope&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;sender_id&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;receiver_id&#39;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s1">&#39;distance_from_previous&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s1">&#39;message_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s1">&#39;message_scope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s1">&#39;sender_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender_id</span><span class="p">)</span>
            <span class="n">message_dict</span><span class="p">[</span><span class="s1">&#39;receiver_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">receiver_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">previous_message_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We imagine that vacuous messages were sent at step -1.</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">distance_from_vacuous</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">previous_message_df</span><span class="p">[</span><span class="s1">&#39;sender_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">sender_id</span><span class="p">)</span> <span class="o">&amp;</span> \
                       <span class="p">(</span><span class="n">previous_message_df</span><span class="p">[</span><span class="s1">&#39;receiver_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">receiver_id</span><span class="p">)</span>
                <span class="n">previous_msg_list</span> <span class="o">=</span> <span class="n">previous_message_df</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s1">&#39;message_object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_msg_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Something strange&#39;</span>
                <span class="n">previous_msg</span> <span class="o">=</span> <span class="n">previous_msg_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">distance_from_other</span><span class="p">(</span><span class="n">previous_msg</span><span class="p">)</span>

            <span class="n">message_dict</span><span class="p">[</span><span class="s1">&#39;distance_from_previous&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        <span class="n">ranked_message_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span>
        <span class="n">ranked_message_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;distance_from_previous&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># debug only</span>
        <span class="n">sorted_index_list</span> <span class="o">=</span> <span class="n">ranked_message_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;distance_from_previous&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">message_passing_index_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sorted_index_list</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_index_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message_passing_index_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ranked_message_df</span></div>

<div class="viewcode-block" id="ClusterGraph.process_graph_async"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.process_graph_async">[docs]</a>    <span class="k">def</span> <span class="nf">process_graph_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform message passing until convergence (or maximum iterations).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># The Cluster Graph contains only single cluster. Message passing not possible or necessary.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                                                         <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="n">max_message_distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">previous_message_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info: Starting iterative message passing.*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iterations</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;iteration: </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_message_distance</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Info: max_message_distance=</span><span class="si">{</span><span class="n">max_message_distance</span><span class="si">}</span><span class="s1"> &lt; tol=</span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s1">. Stopping.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">ranked_message_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ranked_message_df</span><span class="p">(</span><span class="n">previous_message_df</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">message_row</span> <span class="ow">in</span> <span class="n">ranked_message_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message_row</span><span class="p">[</span><span class="s1">&#39;message_object&#39;</span><span class="p">]</span>
                <span class="n">distance_from_previous</span> <span class="o">=</span> <span class="n">message_row</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">distance_from_previous</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Distance from previous message is negative.&#39;</span><span class="p">)</span>
                <span class="c1"># TODO: correct this: if the message is not passed, it must not be included in new_message_distances_df</span>
                <span class="k">if</span> <span class="n">distance_from_previous</span> <span class="o">&gt;=</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">receiver_id</span><span class="si">}</span><span class="se">\t\t\t</span><span class="s1">(dfp: </span><span class="si">{</span><span class="n">distance_from_previous</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="p">,</span> <span class="n">Gaussian</span><span class="p">):</span>
                            <span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">update_covform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_canform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug_passed_message_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pass_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="s1">&#39;Warning: no messages passed.&#39;</span><span class="p">)</span>
            <span class="n">max_message_distance</span> <span class="o">=</span> <span class="n">ranked_message_df</span><span class="p">[</span><span class="s1">&#39;distance_from_previous&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">previous_message_df</span> <span class="o">=</span> <span class="n">ranked_message_df</span>

            <span class="n">new_message_distances_df</span> <span class="o">=</span> <span class="n">ranked_message_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ranked_message_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;message_object&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">iterations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span> <span class="o">=</span> <span class="n">new_message_distances_df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">message_passing_log_df</span><span class="p">,</span>
                                                       <span class="n">right</span><span class="o">=</span><span class="n">new_message_distances_df</span><span class="p">,</span>
                                                       <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sender_id&#39;</span><span class="p">,</span> <span class="s1">&#39;receiver_id&#39;</span><span class="p">],</span>
                                                       <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_iter_</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Info: num_messages_passed = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_animation_gif</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_message_passing_animation_gif</span><span class="p">()</span></div>

<div class="viewcode-block" id="ClusterGraph.get_most_informative_message"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.get_most_informative_message">[docs]</a>    <span class="k">def</span> <span class="nf">get_most_informative_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a dataframe containing message objects, their sender and receiver cluster ids, and the distance from their</span>
<span class="sd">        previous iterations.</span>
<span class="sd">        :return: The message with the highest KL between its current and previous iteration (if more than one, only the</span>
<span class="sd">         last calculated is returned) and the distance from the previous iteration.</span>
<span class="sd">        :rtype: Message, float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_all_messages</span><span class="p">()</span>
        <span class="n">factors_are_vacuous</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">is_vacuous</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">factors_are_vacuous</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: All messages are vacuous&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no messages to send.&#39;</span><span class="p">)</span>

        <span class="n">max_distance</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">max_distance_message</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">receiver_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_passed_message_factors_dict</span><span class="p">:</span>
                <span class="c1"># We imagine that vacuous messages were sent at step -1.</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">distance_from_vacuous</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">previous_msg_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_passed_message_factors_dict</span><span class="p">[(</span><span class="n">msg</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">receiver_id</span><span class="p">)]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">previous_msg_factor</span><span class="o">.</span><span class="n">kl_divergence</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="n">max_distance</span><span class="p">:</span>
                <span class="n">max_distance_message</span> <span class="o">=</span> <span class="n">msg</span>
                <span class="n">max_distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="k">return</span> <span class="n">max_distance_message</span><span class="p">,</span> <span class="n">max_distance</span></div>

<div class="viewcode-block" id="ClusterGraph.process_graph"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.process_graph">[docs]</a>    <span class="k">def</span> <span class="nf">process_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the graph by performing message passing until convergece.</span>
<span class="sd">        :param bool sync: Whether or not to use a synchronous message passing (asynchronous message passing used if False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sync</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_graph_sync</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_graph_async</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span></div>

    <span class="c1"># New Synchronous version</span>
    <span class="c1">#  TODO: make this more efficient, if no messages have been received by a cluster in the previous round, the next</span>
    <span class="c1">#        message iterations from that cluster will be the same.</span>
<div class="viewcode-block" id="ClusterGraph.process_graph_sync"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.process_graph_sync">[docs]</a>    <span class="k">def</span> <span class="nf">process_graph_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform synchronous message passing until convergence (or maximum iterations).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># The Cluster Graph contains only single cluster. Message passing not possible or necessary.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_factor</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                                                         <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">special_evidence</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="n">max_message_distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info: Starting iterative message passing.*&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iterations</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_tqdm</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;iteration: </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">max_iter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">message</span><span class="p">,</span> <span class="n">distance_from_previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_informative_message</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">distance_from_previous</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Info: max_message_distance=</span><span class="si">{</span><span class="n">max_message_distance</span><span class="si">}</span><span class="s1"> &lt; tol=</span><span class="si">{</span><span class="n">tol</span><span class="si">}</span><span class="s1">. Stopping.&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pass_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="s1">&#39;Warning: no messages passed.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Info: num_messages_passed = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_messages_passed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>
        <span class="c1">#if self.make_animation_gif:</span>
        <span class="c1">#    self.make_message_passing_animation_gif()</span>

<div class="viewcode-block" id="ClusterGraph.pass_message"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.pass_message">[docs]</a>    <span class="k">def</span> <span class="nf">pass_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pass message to the relevant receiver.</span>
<span class="sd">        :param message: The message to pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">receiver_cluster_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">receiver_id</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">receiver_cluster_id</span> <span class="o">==</span> <span class="n">cluster</span><span class="o">.</span><span class="n">cluster_id</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">var_names</span><span class="si">}</span><span class="s1"> is not a subset of </span><span class="si">{</span><span class="n">cluster</span><span class="o">.</span><span class="n">var_names</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">var_names</span><span class="p">),</span> <span class="n">error_msg</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">receive_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_passed_message_factors_dict</span><span class="p">[(</span><span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">receiver_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#old</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_animation_gif</span><span class="p">:</span>
                    <span class="n">cg_animation</span><span class="o">.</span><span class="n">add_message_pass_animation_frames</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph</span><span class="p">,</span>
                                                                   <span class="n">frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">message_passing_animation_frames</span><span class="p">,</span>
                                                                   <span class="n">node_a_name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">sender_id</span><span class="p">,</span>
                                                                   <span class="n">node_b_name</span><span class="o">=</span><span class="n">receiver_cluster_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterGraph.make_message_passing_animation_gif"><a class="viewcode-back" href="../../veroku.cluster_graph.html#veroku.cluster_graph.ClusterGraph.make_message_passing_animation_gif">[docs]</a>    <span class="k">def</span> <span class="nf">make_message_passing_animation_gif</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">message_passing_animation_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="s1">&#39;./graph_animation.gif&#39;</span><span class="p">,</span>
                                                      <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF&#39;</span><span class="p">,</span>
                                                      <span class="n">append_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">message_passing_animation_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                                      <span class="n">save_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">veroku</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">veroku</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, EJ Louw.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>